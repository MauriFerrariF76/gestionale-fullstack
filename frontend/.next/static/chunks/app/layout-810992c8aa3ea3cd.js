(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[177],{414:(e,t,n)=>{Promise.resolve().then(n.t.bind(n,9324,23)),Promise.resolve().then(n.bind(n,9548))},2560:(e,t,n)=>{"use strict";n.d(t,{K2:()=>c,WY:()=>a,cG:()=>s});var o=n(5155),r=n(2115);let l=(0,r.createContext)(void 0),a=e=>{let{children:t}=e,[n,a]=(0,r.useState)(new Map),[s,i]=(0,r.useState)(0),c=(0,r.useCallback)(()=>{i(e=>e+1)},[]),u=(0,r.useCallback)(e=>{a(t=>new Map(t.set(e.id,e)))},[]),f=(0,r.useCallback)(e=>n.get(e),[n]),d=(0,r.useCallback)(e=>{try{let t=localStorage.getItem("table_config_".concat(e));if(t){let n=JSON.parse(t);return{visibleColumns:n.visibleColumns||g(e).visibleColumns,sortConfig:n.sortConfig||null}}}catch(t){console.warn("Errore caricamento config per ".concat(e,":"),t)}return g(e)},[n]),g=(0,r.useCallback)(e=>{let t=n.get(e);return{visibleColumns:(null==t?void 0:t.defaultVisibleColumns)||[],sortConfig:null}},[n]),h=(0,r.useCallback)((e,t)=>{try{localStorage.setItem("table_config_".concat(e),JSON.stringify(t))}catch(t){console.warn("Errore salvataggio config per ".concat(e,":"),t)}},[]),C=(0,r.useCallback)(e=>d(e),[d]),m=(0,r.useCallback)((e,t)=>{let n={...d(e),...t};h(e,n),c()},[d,h,c]),b=(0,r.useCallback)(e=>{let t=g(e);h(e,t),localStorage.removeItem("table_config_".concat(e)),c()},[g,h,c]),p=(0,r.useCallback)((e,t)=>{let o=n.get(e),r=null==o?void 0:o.columns.find(e=>e.key===t);if((null==r?void 0:r.sortable)===!1)return;let l=d(e).sortConfig,a=null;(null==l?void 0:l.key)===t?"asc"===l.direction&&(a={key:t,direction:"desc"}):a={key:t,direction:"asc"},m(e,{sortConfig:a})},[n,d,m]),v=(0,r.useCallback)((e,t)=>{let n=d(e).sortConfig;return n?[...t].sort((e,t)=>{let o=e[n.key],r=t[n.key];return null==o?1:null==r?-1:o<r?"asc"===n.direction?-1:1:o>r?"asc"===n.direction?1:-1:0}):t},[d]),S=(0,r.useCallback)(e=>{let t=n.get(e),o=d(e);return t?o.visibleColumns.map(e=>{let n=t.columns.find(t=>t.key===e);return n||null}).filter(Boolean):[]},[n,d]),y=(0,r.useCallback)(()=>{let e={};n.forEach((t,n)=>{e[n]=d(n)});let t=new Blob([JSON.stringify({version:"1.0",timestamp:new Date().toISOString(),app:"Ferrari Pietro SNC - Gestionale",configs:e},null,2)],{type:"application/json"}),o=new Date,r="gestionale-".concat(o.getDate().toString().padStart(2,"0"),"-").concat((o.getMonth()+1).toString().padStart(2,"0"),"-").concat(o.getFullYear(),"-").concat(o.getHours().toString().padStart(2,"0"),"-").concat(o.getMinutes().toString().padStart(2,"0"),".json"),l=URL.createObjectURL(t),a=document.createElement("a");a.href=l,a.download=r,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(l)},[n,d]),k=(0,r.useCallback)(e=>{if(!e||"object"!=typeof e||null===e||!("configs"in e))return void console.error("Formato file non valido");try{let t=e.configs;Object.entries(t).forEach(e=>{let[t,o]=e;n.has(t)&&h(t,o)}),window.location.reload()}catch(e){console.error("Errore durante l'import:",e)}},[n,h]);return(0,o.jsx)(l.Provider,{value:{registerSchema:u,getSchema:f,getConfig:C,updateConfig:m,resetConfig:b,handleSort:p,sortData:v,exportConfig:y,importConfig:k,getVisibleColumnsWithConfig:S},children:t})},s=()=>{let e=(0,r.useContext)(l);if(void 0===e)throw Error("useTableConfig deve essere usato dentro TableConfigProvider");return e},i=()=>{let[e,t]=(0,r.useState)(!1);return r.useEffect(()=>{t(!0)},[]),e},c=e=>{let t=s(),n=i(),o=t.getConfig(e),r=t.getSchema(e);return{visibleColumns:o.visibleColumns,sortConfig:n?o.sortConfig:null,allColumns:(null==r?void 0:r.columns)||[],defaultColumns:(null==r?void 0:r.defaultVisibleColumns)||[],updateConfig:n=>t.updateConfig(e,n),resetConfig:()=>t.resetConfig(e),handleSort:n=>t.handleSort(e,n),sortData:n=>t.sortData(e,n),getVisibleColumnsWithConfig:()=>t.getVisibleColumnsWithConfig(e),isClient:n}}},3274:(e,t,n)=>{"use strict";n.d(t,{A:()=>s,O:()=>i});var o=n(5155),r=n(2115);function l(e){return"".concat("/api".replace(/\/$/,""),"/").concat(e.replace(/^\//,""))}let a=(0,r.createContext)(void 0);function s(){let e=(0,r.useContext)(a);if(!e)throw Error("useAuth deve essere usato dentro AuthProvider");return e}let i=e=>{let{children:t}=e,[n,s]=(0,r.useState)(null),[i,c]=(0,r.useState)(null),[u,f]=(0,r.useState)(null),[d,g]=(0,r.useState)(!0),[h,C]=(0,r.useState)(!1),[m,b]=(0,r.useState)(null);async function p(e,t,n){g(!0),C(!1),b(null);try{let o=await fetch(l("auth/login"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:t,mfaCode:n})}),r=await o.json();if(r.mfaRequired&&r.userId)C(!0),b(r.userId),c(null),f(null),s(null);else if(r.accessToken&&r.refreshToken&&r.user)c(r.accessToken),f(r.refreshToken),s(r.user),C(!1),b(null),await k("login","Login riuscito");else if(r.error)throw Error(r.error)}catch(e){if(s(null),c(null),f(null),e instanceof Error)throw e;throw Error("Errore sconosciuto durante il login")}finally{g(!1)}}async function v(e,t){g(!0);try{let n=await fetch(l("auth/mfa/verify"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:e,mfaCode:t})}),o=await n.json();if(o.success&&o.accessToken&&o.refreshToken)c(o.accessToken),f(o.refreshToken),C(!1),b(null),await y(),await k("mfa","MFA verificato");else if(o.error)throw Error(o.error)}catch(e){throw e}finally{g(!1)}}async function S(){g(!0);try{u&&await fetch(l("auth/logout"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refreshToken:u})}),s(null),c(null),f(null),C(!1),b(null),await k("logout","Logout utente")}finally{g(!1)}}async function y(){if(i){g(!0);try{let e=await fetch(l("auth/userinfo"),{method:"GET",headers:{Authorization:"Bearer ".concat(i)}}),t=await e.json();t.user?s(t.user):s(null)}catch(e){s(null)}finally{g(!1)}}}async function k(e,t){try{await fetch(l("auth/log"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:(null==n?void 0:n.id)||m,action:e,ip:void 0,timestamp:new Date().toISOString(),details:t})})}catch(e){}}return(0,r.useEffect)(()=>{let e=sessionStorage.getItem("accessToken"),t=sessionStorage.getItem("refreshToken");e&&t&&(c(e),f(t)),g(!1)},[]),(0,r.useEffect)(()=>{i?sessionStorage.setItem("accessToken",i):sessionStorage.removeItem("accessToken"),u?sessionStorage.setItem("refreshToken",u):sessionStorage.removeItem("refreshToken")},[i,u]),(0,r.useEffect)(()=>{i?y():s(null)},[i]),(0,o.jsx)(a.Provider,{value:{user:n,accessToken:i,refreshToken:u,isAuthenticated:!!n&&!!i,loading:d,mfaRequired:h,login:p,verifyMfa:v,logout:S,fetchUser:y},children:t})}},9324:()=>{},9548:(e,t,n)=>{"use strict";n.d(t,{default:()=>f});var o=n(5155),r=n(5695),l=n(3274),a=n(2115);function s(e){let{children:t}=e,{isAuthenticated:n,loading:s}=(0,l.A)(),i=(0,r.useRouter)();return((0,a.useEffect)(()=>{s||n||i.replace("/login")},[n,s,i]),s)?(0,o.jsx)("div",{className:"text-center py-10 text-info",children:"Caricamento autenticazione..."}):n?(0,o.jsx)(o.Fragment,{children:t}):null}var i=n(2560),c=n(6485),u=n(8974);function f(e){let{children:t}=e,n=(0,r.usePathname)();return(0,o.jsxs)(l.O,{children:[(0,o.jsx)(i.WY,{children:"/login"===n?t:(0,o.jsx)(s,{children:t})}),(0,o.jsx)(c.G,{config:{plugins:[u.A]}})]})}}},e=>{var t=t=>e(e.s=t);e.O(0,[533,560,441,684,358],()=>t(414)),_N_E=e.O()}]);