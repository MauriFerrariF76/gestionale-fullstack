[Wed Jul 30 08:49:51 AM CEST 2025] Inizio test restore dinamico backup database
[Wed Jul 30 08:49:51 AM CEST 2025] Backup da testare: /mnt/backup_gestionale/database/gestionale_db_20250730_084946_standard.backup
[Wed Jul 30 08:49:51 AM CEST 2025] Creazione database temporaneo gestionale_test_restore...
createdb: error: database creation failed: ERROR:  database "gestionale_test_restore" already exists
[Wed Jul 30 08:49:51 AM CEST 2025] Configurazione permessi utente...
GRANT
GRANT
GRANT
GRANT
ALTER DEFAULT PRIVILEGES
ALTER DEFAULT PRIVILEGES
[Wed Jul 30 08:49:52 AM CEST 2025] Esecuzione restore nel database temporaneo...
pg_restore: connecting to database for restore
pg_restore: creating FUNCTION "public.update_updated_at_column()"
pg_restore: while PROCESSING TOC:
pg_restore: from TOC entry 219; 1255 16413 FUNCTION update_updated_at_column() gestionale_user
pg_restore: error: could not execute query: ERROR:  function "update_updated_at_column" already exists with same argument types
Command was: CREATE FUNCTION public.update_updated_at_column() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$;


pg_restore: creating TABLE "public.audit_logs"
pg_restore: from TOC entry 218; 1259 16499 TABLE audit_logs gestionale_user
pg_restore: error: could not execute query: ERROR:  relation "audit_logs" already exists
Command was: CREATE TABLE public.audit_logs (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid,
    action character varying(50) NOT NULL,
    ip character varying(45) NOT NULL,
    "timestamp" timestamp with time zone DEFAULT now() NOT NULL,
    details text
);


pg_restore: creating TABLE "public.clienti"
pg_restore: from TOC entry 215; 1259 16431 TABLE clienti gestionale_user
pg_restore: error: could not execute query: ERROR:  relation "clienti" already exists
Command was: CREATE TABLE public.clienti (
    "IdCliente" character varying(255) NOT NULL,
    "CodiceMT" character varying(255),
    "RagioneSocialeC" character varying(255) NOT NULL,
    "ReferenteC" character varying(255),
    "IndirizzoC" character varying(255),
    "CAPc" character varying(255),
    "CITTAc" character varying(255),
    "PROVc" character varying(255),
    "NAZc" character varying(255),
    "IndirizzoC2" character varying(255),
    "CAPc2" character varying(255),
    "CITTAc2" character varying(255),
    "PROVc2" character varying(255),
    "NAZc2" character varying(255),
    "IndirizzoC3" character varying(255),
    "CAPc3" character varying(255),
    "CITTAc3" character varying(255),
    "PROVc3" character varying(255),
    "NAZc3" character varying(255),
    "IntestazioneSpedFat" character varying(255),
    "IndirizzoC4" character varying(255),
    "CAPc4" character varying(255),
    "CITTAc4" character varying(255),
    "PROVc4" character varying(255),
    "SelezioneSpedFat" boolean DEFAULT false,
    "NoteSpedFat" text,
    "DescrizionePagamentoC" character varying(255),
    "MetodoPagamentoC" character varying(255),
    "CondizioniPagamentoC" character varying(255),
    "ResaC" character varying(255),
    "TrasportoC" character varying(255),
    "EffettivoPotenziale" character varying(255),
    "CategoriaMerceologica" character varying(255),
    "AttivoC" boolean DEFAULT true,
    "AttivoDalC" date,
    "NonAttivoDalC" date,
    "AnnoUltimoVendita" integer,
    "Telefono" character varying(50),
    "Fax" character varying(50),
    "Modem" character varying(50),
    "CodiceFiscale" character varying(16),
    "PartitaIva" character varying(20),
    "BancaAppoggio" text,
    "CodicePagamento" character varying(50),
    "SitoInternet" character varying(255),
    "EsenzioneIva" text,
    "EmailFatturazione" character varying(255),
    "CodiceFornitore" character varying(255),
    "CIN" character varying(10),
    "ABI" character varying(10),
    "CAB" character varying(10),
    "CC" character varying(255),
    "CodiceIBAN" character varying(50),
    "TipoSpedizioneC" character varying(255),
    "Articolo15" numeric(10,2),
    "NostraBancaAppoggioC" character varying(255),
    "IBANnostraBancaC" character varying(50),
    "PercorsoCliente" character varying(500),
    "PercorsoPDFClienteC" character varying(500),
    "PercorsoDXFClienteC" character varying(500),
    "Privato" boolean DEFAULT false,
    "IVA" numeric(5,2),
    "EmailCertificati" character varying(255),
    "CodiceSDI" character varying(50),
    "PECcliente" character varying(255),
    "SpeseBancarie" numeric(10,2),
    "RichiesteCliente" text,
    created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP
);


pg_restore: creating TABLE "public.refresh_tokens"
pg_restore: from TOC entry 217; 1259 16484 TABLE refresh_tokens gestionale_user
pg_restore: error: could not execute query: ERROR:  relation "refresh_tokens" already exists
Command was: CREATE TABLE public.refresh_tokens (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid,
    token character varying(512) NOT NULL,
    expires_at timestamp with time zone NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    revoked boolean DEFAULT false NOT NULL
);


pg_restore: creating TABLE "public.users"
pg_restore: from TOC entry 216; 1259 16472 TABLE users gestionale_user
pg_restore: error: could not execute query: ERROR:  relation "users" already exists
Command was: CREATE TABLE public.users (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    email character varying(255) NOT NULL,
    nome character varying(100) NOT NULL,
    cognome character varying(100) NOT NULL,
    password_hash character varying(255) NOT NULL,
    roles text[] DEFAULT ARRAY['user'::text] NOT NULL,
    mfa_enabled boolean DEFAULT false NOT NULL
);


pg_restore: processing data for table "public.audit_logs"
pg_restore: from TOC entry 3432; 0 16499 TABLE DATA audit_logs gestionale_user
pg_restore: error: COPY failed for table "audit_logs": ERROR:  duplicate key value violates unique constraint "audit_logs_pkey"
DETAIL:  Key (id)=(5a3d35d9-81a4-4568-a330-c0a7543187fa) already exists.
CONTEXT:  COPY audit_logs, line 1
pg_restore: processing data for table "public.clienti"
pg_restore: from TOC entry 3429; 0 16431 TABLE DATA clienti gestionale_user
pg_restore: error: COPY failed for table "clienti": ERROR:  duplicate key value violates unique constraint "clienti_pkey"
DETAIL:  Key ("IdCliente")=(C00.0036) already exists.
CONTEXT:  COPY clienti, line 1
pg_restore: processing data for table "public.refresh_tokens"
pg_restore: from TOC entry 3431; 0 16484 TABLE DATA refresh_tokens gestionale_user
pg_restore: error: COPY failed for table "refresh_tokens": ERROR:  duplicate key value violates unique constraint "refresh_tokens_pkey"
DETAIL:  Key (id)=(07b1621a-8844-4dbc-ade5-553f506ce3aa) already exists.
CONTEXT:  COPY refresh_tokens, line 1
pg_restore: processing data for table "public.users"
pg_restore: from TOC entry 3430; 0 16472 TABLE DATA users gestionale_user
pg_restore: error: COPY failed for table "users": ERROR:  duplicate key value violates unique constraint "users_email_key"
DETAIL:  Key (email)=(mauriferrari76@gmail.com) already exists.
CONTEXT:  COPY users, line 1
pg_restore: creating CONSTRAINT "public.audit_logs audit_logs_pkey"
pg_restore: from TOC entry 3283; 2606 16507 CONSTRAINT audit_logs audit_logs_pkey gestionale_user
pg_restore: error: could not execute query: ERROR:  multiple primary keys for table "audit_logs" are not allowed
Command was: ALTER TABLE ONLY public.audit_logs
    ADD CONSTRAINT audit_logs_pkey PRIMARY KEY (id);


pg_restore: creating CONSTRAINT "public.clienti clienti_pkey"
pg_restore: from TOC entry 3275; 2606 16442 CONSTRAINT clienti clienti_pkey gestionale_user
pg_restore: error: could not execute query: ERROR:  multiple primary keys for table "clienti" are not allowed
Command was: ALTER TABLE ONLY public.clienti
    ADD CONSTRAINT clienti_pkey PRIMARY KEY ("IdCliente");


pg_restore: creating CONSTRAINT "public.refresh_tokens refresh_tokens_pkey"
pg_restore: from TOC entry 3281; 2606 16493 CONSTRAINT refresh_tokens refresh_tokens_pkey gestionale_user
pg_restore: error: could not execute query: ERROR:  multiple primary keys for table "refresh_tokens" are not allowed
Command was: ALTER TABLE ONLY public.refresh_tokens
    ADD CONSTRAINT refresh_tokens_pkey PRIMARY KEY (id);


pg_restore: creating CONSTRAINT "public.users users_email_key"
pg_restore: from TOC entry 3277; 2606 16483 CONSTRAINT users users_email_key gestionale_user
pg_restore: error: could not execute query: ERROR:  relation "users_email_key" already exists
Command was: ALTER TABLE ONLY public.users
    ADD CONSTRAINT users_email_key UNIQUE (email);


pg_restore: creating CONSTRAINT "public.users users_pkey"
pg_restore: from TOC entry 3279; 2606 16481 CONSTRAINT users users_pkey gestionale_user
pg_restore: error: could not execute query: ERROR:  multiple primary keys for table "users" are not allowed
Command was: ALTER TABLE ONLY public.users
    ADD CONSTRAINT users_pkey PRIMARY KEY (id);


pg_restore: creating FK CONSTRAINT "public.audit_logs audit_logs_user_id_fkey"
pg_restore: from TOC entry 3285; 2606 16508 FK CONSTRAINT audit_logs audit_logs_user_id_fkey gestionale_user
pg_restore: error: could not execute query: ERROR:  constraint "audit_logs_user_id_fkey" for relation "audit_logs" already exists
Command was: ALTER TABLE ONLY public.audit_logs
    ADD CONSTRAINT audit_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id) ON DELETE SET NULL;


pg_restore: creating FK CONSTRAINT "public.refresh_tokens refresh_tokens_user_id_fkey"
pg_restore: from TOC entry 3284; 2606 16494 FK CONSTRAINT refresh_tokens refresh_tokens_user_id_fkey gestionale_user
pg_restore: error: could not execute query: ERROR:  constraint "refresh_tokens_user_id_fkey" for relation "refresh_tokens" already exists
Command was: ALTER TABLE ONLY public.refresh_tokens
    ADD CONSTRAINT refresh_tokens_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id) ON DELETE CASCADE;


pg_restore: warning: errors ignored on restore: 16
[Wed Jul 30 08:49:52 AM CEST 2025] ERRORE: Restore fallito! Codice: 1
[Wed Jul 30 08:50:09 AM CEST 2025] Inizio test restore dinamico backup database
[Wed Jul 30 08:50:09 AM CEST 2025] Backup da testare: /mnt/backup_gestionale/database/gestionale_db_20250730_084946_standard.backup
[Wed Jul 30 08:50:09 AM CEST 2025] Creazione database temporaneo gestionale_test_restore...
[Wed Jul 30 08:50:09 AM CEST 2025] Configurazione permessi utente...
GRANT
GRANT
GRANT
GRANT
ALTER DEFAULT PRIVILEGES
ALTER DEFAULT PRIVILEGES
[Wed Jul 30 08:50:09 AM CEST 2025] Esecuzione restore nel database temporaneo...
pg_restore: connecting to database for restore
pg_restore: creating FUNCTION "public.update_updated_at_column()"
pg_restore: creating TABLE "public.audit_logs"
pg_restore: creating TABLE "public.clienti"
pg_restore: creating TABLE "public.refresh_tokens"
pg_restore: creating TABLE "public.users"
pg_restore: processing data for table "public.audit_logs"
pg_restore: processing data for table "public.clienti"
pg_restore: processing data for table "public.refresh_tokens"
pg_restore: processing data for table "public.users"
pg_restore: creating CONSTRAINT "public.audit_logs audit_logs_pkey"
pg_restore: creating CONSTRAINT "public.clienti clienti_pkey"
pg_restore: creating CONSTRAINT "public.refresh_tokens refresh_tokens_pkey"
pg_restore: creating CONSTRAINT "public.users users_email_key"
pg_restore: creating CONSTRAINT "public.users users_pkey"
pg_restore: creating FK CONSTRAINT "public.audit_logs audit_logs_user_id_fkey"
pg_restore: creating FK CONSTRAINT "public.refresh_tokens refresh_tokens_user_id_fkey"
[Wed Jul 30 08:50:10 AM CEST 2025] Test connessione e query base...
 table_count 
-------------
           4
(1 row)

[Wed Jul 30 08:50:10 AM CEST 2025] Test dinamico su tutte le tabelle...
   table_name   | record_count 
----------------+--------------
 audit_logs     |           55
 clienti        |           10
 refresh_tokens |           31
 users          |            1
(4 rows)

[Wed Jul 30 08:50:10 AM CEST 2025] Test funzioni e stored procedures...
       routine_name       | routine_type | data_type 
--------------------------+--------------+-----------
 update_updated_at_column | FUNCTION     | trigger
(1 row)

[Wed Jul 30 08:50:10 AM CEST 2025] Test triggers...
 trigger_name | event_manipulation | event_object_table 
--------------+--------------------+--------------------
(0 rows)

[Wed Jul 30 08:50:10 AM CEST 2025] Pulizia database temporaneo...
[Wed Jul 30 08:50:10 AM CEST 2025] Test restore dinamico completato con successo!
