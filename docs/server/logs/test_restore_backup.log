[Tue Jul 29 02:02:08 PM CEST 2025] Inizio test restore backup database
[Tue Jul 29 02:02:08 PM CEST 2025] Backup da testare: /mnt/backup_gestionale/database/gestionale_db_20250729_140202.backup
[Tue Jul 29 02:02:08 PM CEST 2025] Creazione database temporaneo gestionale_test_restore...
createdb: error: connection to server at "localhost" (127.0.0.1), port 5432 failed: FATAL:  password authentication failed for user "gestionale_user"
connection to server at "localhost" (127.0.0.1), port 5432 failed: FATAL:  password authentication failed for user "gestionale_user"
[Tue Jul 29 02:02:28 PM CEST 2025] Esecuzione restore nel database temporaneo...
pg_restore: connecting to database for restore
pg_restore: error: connection to server at "localhost" (127.0.0.1), port 5432 failed: FATAL:  database "gestionale_test_restore" does not exist
[Tue Jul 29 02:02:36 PM CEST 2025] ERRORE: Restore fallito! Codice: 1
[Tue Jul 29 02:03:29 PM CEST 2025] Inizio test restore backup database
[Tue Jul 29 02:03:29 PM CEST 2025] Backup da testare: /mnt/backup_gestionale/database/gestionale_db_20250729_140202.backup
[Tue Jul 29 02:03:29 PM CEST 2025] Creazione database temporaneo gestionale_test_restore...
[Tue Jul 29 02:03:29 PM CEST 2025] Esecuzione restore nel database temporaneo...
pg_restore: connecting to database for restore
pg_restore: error: connection to server at "localhost" (127.0.0.1), port 5432 failed: FATAL:  password authentication failed for user "gestionale_user"
connection to server at "localhost" (127.0.0.1), port 5432 failed: FATAL:  password authentication failed for user "gestionale_user"
[Tue Jul 29 02:03:35 PM CEST 2025] ERRORE: Restore fallito! Codice: 1
[Tue Jul 29 02:04:16 PM CEST 2025] Inizio test restore backup database
[Tue Jul 29 02:04:16 PM CEST 2025] Backup da testare: /mnt/backup_gestionale/database/gestionale_db_20250729_140202.backup
[Tue Jul 29 02:04:16 PM CEST 2025] Creazione database temporaneo gestionale_test_restore...
[Tue Jul 29 02:04:16 PM CEST 2025] Esecuzione restore nel database temporaneo...
pg_restore: connecting to database for restore
pg_restore: creating FUNCTION "public.update_updated_at_column()"
pg_restore: while PROCESSING TOC:
pg_restore: from TOC entry 219; 1255 16413 FUNCTION update_updated_at_column() gestionale_user
pg_restore: error: could not execute query: ERROR:  permission denied for schema public
Command was: CREATE FUNCTION public.update_updated_at_column() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$;


pg_restore: error: could not execute query: ERROR:  function public.update_updated_at_column() does not exist
Command was: ALTER FUNCTION public.update_updated_at_column() OWNER TO gestionale_user;

pg_restore: creating TABLE "public.audit_logs"
pg_restore: from TOC entry 218; 1259 16499 TABLE audit_logs gestionale_user
pg_restore: error: could not execute query: ERROR:  permission denied for schema public
LINE 1: CREATE TABLE public.audit_logs (
                     ^
Command was: CREATE TABLE public.audit_logs (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid,
    action character varying(50) NOT NULL,
    ip character varying(45) NOT NULL,
    "timestamp" timestamp with time zone DEFAULT now() NOT NULL,
    details text
);


pg_restore: error: could not execute query: ERROR:  relation "public.audit_logs" does not exist
Command was: ALTER TABLE public.audit_logs OWNER TO gestionale_user;

pg_restore: creating TABLE "public.clienti"
pg_restore: from TOC entry 215; 1259 16431 TABLE clienti gestionale_user
pg_restore: error: could not execute query: ERROR:  permission denied for schema public
LINE 1: CREATE TABLE public.clienti (
                     ^
Command was: CREATE TABLE public.clienti (
    "IdCliente" character varying(255) NOT NULL,
    "CodiceMT" character varying(255),
    "RagioneSocialeC" character varying(255) NOT NULL,
    "ReferenteC" character varying(255),
    "IndirizzoC" character varying(255),
    "CAPc" character varying(255),
    "CITTAc" character varying(255),
    "PROVc" character varying(255),
    "NAZc" character varying(255),
    "IndirizzoC2" character varying(255),
    "CAPc2" character varying(255),
    "CITTAc2" character varying(255),
    "PROVc2" character varying(255),
    "NAZc2" character varying(255),
    "IndirizzoC3" character varying(255),
    "CAPc3" character varying(255),
    "CITTAc3" character varying(255),
    "PROVc3" character varying(255),
    "NAZc3" character varying(255),
    "IntestazioneSpedFat" character varying(255),
    "IndirizzoC4" character varying(255),
    "CAPc4" character varying(255),
    "CITTAc4" character varying(255),
    "PROVc4" character varying(255),
    "SelezioneSpedFat" boolean DEFAULT false,
    "NoteSpedFat" text,
    "DescrizionePagamentoC" character varying(255),
    "MetodoPagamentoC" character varying(255),
    "CondizioniPagamentoC" character varying(255),
    "ResaC" character varying(255),
    "TrasportoC" character varying(255),
    "EffettivoPotenziale" character varying(255),
    "CategoriaMerceologica" character varying(255),
    "AttivoC" boolean DEFAULT true,
    "AttivoDalC" date,
    "NonAttivoDalC" date,
    "AnnoUltimoVendita" integer,
    "Telefono" character varying(50),
    "Fax" character varying(50),
    "Modem" character varying(50),
    "CodiceFiscale" character varying(16),
    "PartitaIva" character varying(20),
    "BancaAppoggio" text,
    "CodicePagamento" character varying(50),
    "SitoInternet" character varying(255),
    "EsenzioneIva" text,
    "EmailFatturazione" character varying(255),
    "CodiceFornitore" character varying(255),
    "CIN" character varying(10),
    "ABI" character varying(10),
    "CAB" character varying(10),
    "CC" character varying(255),
    "CodiceIBAN" character varying(50),
    "TipoSpedizioneC" character varying(255),
    "Articolo15" numeric(10,2),
    "NostraBancaAppoggioC" character varying(255),
    "IBANnostraBancaC" character varying(50),
    "PercorsoCliente" character varying(500),
    "PercorsoPDFClienteC" character varying(500),
    "PercorsoDXFClienteC" character varying(500),
    "Privato" boolean DEFAULT false,
    "IVA" numeric(5,2),
    "EmailCertificati" character varying(255),
    "CodiceSDI" character varying(50),
    "PECcliente" character varying(255),
    "SpeseBancarie" numeric(10,2),
    "RichiesteCliente" text,
    created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP
);


pg_restore: error: could not execute query: ERROR:  relation "public.clienti" does not exist
Command was: ALTER TABLE public.clienti OWNER TO gestionale_user;

pg_restore: creating TABLE "public.refresh_tokens"
pg_restore: from TOC entry 217; 1259 16484 TABLE refresh_tokens gestionale_user
pg_restore: error: could not execute query: ERROR:  permission denied for schema public
LINE 1: CREATE TABLE public.refresh_tokens (
                     ^
Command was: CREATE TABLE public.refresh_tokens (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid,
    token character varying(512) NOT NULL,
    expires_at timestamp with time zone NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    revoked boolean DEFAULT false NOT NULL
);


pg_restore: error: could not execute query: ERROR:  relation "public.refresh_tokens" does not exist
Command was: ALTER TABLE public.refresh_tokens OWNER TO gestionale_user;

pg_restore: creating TABLE "public.users"
pg_restore: from TOC entry 216; 1259 16472 TABLE users gestionale_user
pg_restore: error: could not execute query: ERROR:  permission denied for schema public
LINE 1: CREATE TABLE public.users (
                     ^
Command was: CREATE TABLE public.users (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    email character varying(255) NOT NULL,
    nome character varying(100) NOT NULL,
    cognome character varying(100) NOT NULL,
    password_hash character varying(255) NOT NULL,
    roles text[] DEFAULT ARRAY['user'::text] NOT NULL,
    mfa_enabled boolean DEFAULT false NOT NULL
);


pg_restore: error: could not execute query: ERROR:  relation "public.users" does not exist
Command was: ALTER TABLE public.users OWNER TO gestionale_user;

pg_restore: processing data for table "public.audit_logs"
pg_restore: from TOC entry 3432; 0 16499 TABLE DATA audit_logs gestionale_user
pg_restore: error: could not execute query: ERROR:  relation "public.audit_logs" does not exist
Command was: COPY public.audit_logs (id, user_id, action, ip, "timestamp", details) FROM stdin;
pg_restore: processing data for table "public.clienti"
pg_restore: from TOC entry 3429; 0 16431 TABLE DATA clienti gestionale_user
pg_restore: error: could not execute query: ERROR:  relation "public.clienti" does not exist
Command was: COPY public.clienti ("IdCliente", "CodiceMT", "RagioneSocialeC", "ReferenteC", "IndirizzoC", "CAPc", "CITTAc", "PROVc", "NAZc", "IndirizzoC2", "CAPc2", "CITTAc2", "PROVc2", "NAZc2", "IndirizzoC3", "CAPc3", "CITTAc3", "PROVc3", "NAZc3", "IntestazioneSpedFat", "IndirizzoC4", "CAPc4", "CITTAc4", "PROVc4", "SelezioneSpedFat", "NoteSpedFat", "DescrizionePagamentoC", "MetodoPagamentoC", "CondizioniPagamentoC", "ResaC", "TrasportoC", "EffettivoPotenziale", "CategoriaMerceologica", "AttivoC", "AttivoDalC", "NonAttivoDalC", "AnnoUltimoVendita", "Telefono", "Fax", "Modem", "CodiceFiscale", "PartitaIva", "BancaAppoggio", "CodicePagamento", "SitoInternet", "EsenzioneIva", "EmailFatturazione", "CodiceFornitore", "CIN", "ABI", "CAB", "CC", "CodiceIBAN", "TipoSpedizioneC", "Articolo15", "NostraBancaAppoggioC", "IBANnostraBancaC", "PercorsoCliente", "PercorsoPDFClienteC", "PercorsoDXFClienteC", "Privato", "IVA", "EmailCertificati", "CodiceSDI", "PECcliente", "SpeseBancarie", "RichiesteCliente", created_at, updated_at) FROM stdin;
pg_restore: processing data for table "public.refresh_tokens"
pg_restore: from TOC entry 3431; 0 16484 TABLE DATA refresh_tokens gestionale_user
pg_restore: error: could not execute query: ERROR:  relation "public.refresh_tokens" does not exist
Command was: COPY public.refresh_tokens (id, user_id, token, expires_at, created_at, revoked) FROM stdin;
pg_restore: processing data for table "public.users"
pg_restore: from TOC entry 3430; 0 16472 TABLE DATA users gestionale_user
pg_restore: error: could not execute query: ERROR:  relation "public.users" does not exist
Command was: COPY public.users (id, email, nome, cognome, password_hash, roles, mfa_enabled) FROM stdin;
pg_restore: creating CONSTRAINT "public.audit_logs audit_logs_pkey"
pg_restore: from TOC entry 3283; 2606 16507 CONSTRAINT audit_logs audit_logs_pkey gestionale_user
pg_restore: error: could not execute query: ERROR:  relation "public.audit_logs" does not exist
Command was: ALTER TABLE ONLY public.audit_logs
    ADD CONSTRAINT audit_logs_pkey PRIMARY KEY (id);


pg_restore: creating CONSTRAINT "public.clienti clienti_pkey"
pg_restore: from TOC entry 3275; 2606 16442 CONSTRAINT clienti clienti_pkey gestionale_user
pg_restore: error: could not execute query: ERROR:  relation "public.clienti" does not exist
Command was: ALTER TABLE ONLY public.clienti
    ADD CONSTRAINT clienti_pkey PRIMARY KEY ("IdCliente");


pg_restore: creating CONSTRAINT "public.refresh_tokens refresh_tokens_pkey"
pg_restore: from TOC entry 3281; 2606 16493 CONSTRAINT refresh_tokens refresh_tokens_pkey gestionale_user
pg_restore: error: could not execute query: ERROR:  relation "public.refresh_tokens" does not exist
Command was: ALTER TABLE ONLY public.refresh_tokens
    ADD CONSTRAINT refresh_tokens_pkey PRIMARY KEY (id);


pg_restore: creating CONSTRAINT "public.users users_email_key"
pg_restore: from TOC entry 3277; 2606 16483 CONSTRAINT users users_email_key gestionale_user
pg_restore: error: could not execute query: ERROR:  relation "public.users" does not exist
Command was: ALTER TABLE ONLY public.users
    ADD CONSTRAINT users_email_key UNIQUE (email);


pg_restore: creating CONSTRAINT "public.users users_pkey"
pg_restore: from TOC entry 3279; 2606 16481 CONSTRAINT users users_pkey gestionale_user
pg_restore: error: could not execute query: ERROR:  relation "public.users" does not exist
Command was: ALTER TABLE ONLY public.users
    ADD CONSTRAINT users_pkey PRIMARY KEY (id);


pg_restore: creating FK CONSTRAINT "public.audit_logs audit_logs_user_id_fkey"
pg_restore: from TOC entry 3285; 2606 16508 FK CONSTRAINT audit_logs audit_logs_user_id_fkey gestionale_user
pg_restore: error: could not execute query: ERROR:  relation "public.audit_logs" does not exist
Command was: ALTER TABLE ONLY public.audit_logs
    ADD CONSTRAINT audit_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id) ON DELETE SET NULL;


pg_restore: creating FK CONSTRAINT "public.refresh_tokens refresh_tokens_user_id_fkey"
pg_restore: from TOC entry 3284; 2606 16494 FK CONSTRAINT refresh_tokens refresh_tokens_user_id_fkey gestionale_user
pg_restore: error: could not execute query: ERROR:  relation "public.refresh_tokens" does not exist
Command was: ALTER TABLE ONLY public.refresh_tokens
    ADD CONSTRAINT refresh_tokens_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id) ON DELETE CASCADE;


pg_restore: warning: errors ignored on restore: 21
[Tue Jul 29 02:04:22 PM CEST 2025] ERRORE: Restore fallito! Codice: 1
[Tue Jul 29 02:05:10 PM CEST 2025] Inizio test restore backup database
[Tue Jul 29 02:05:11 PM CEST 2025] Backup da testare: /mnt/backup_gestionale/database/gestionale_db_20250729_140202.backup
[Tue Jul 29 02:05:11 PM CEST 2025] Creazione database temporaneo gestionale_test_restore...
[Tue Jul 29 02:05:11 PM CEST 2025] Configurazione permessi utente...
GRANT
GRANT
GRANT
GRANT
ALTER DEFAULT PRIVILEGES
ALTER DEFAULT PRIVILEGES
[Tue Jul 29 02:05:11 PM CEST 2025] Esecuzione restore nel database temporaneo...
pg_restore: connecting to database for restore
pg_restore: creating FUNCTION "public.update_updated_at_column()"
pg_restore: creating TABLE "public.audit_logs"
pg_restore: creating TABLE "public.clienti"
pg_restore: creating TABLE "public.refresh_tokens"
pg_restore: creating TABLE "public.users"
pg_restore: processing data for table "public.audit_logs"
pg_restore: processing data for table "public.clienti"
pg_restore: processing data for table "public.refresh_tokens"
pg_restore: processing data for table "public.users"
pg_restore: creating CONSTRAINT "public.audit_logs audit_logs_pkey"
pg_restore: creating CONSTRAINT "public.clienti clienti_pkey"
pg_restore: creating CONSTRAINT "public.refresh_tokens refresh_tokens_pkey"
pg_restore: creating CONSTRAINT "public.users users_email_key"
pg_restore: creating CONSTRAINT "public.users users_pkey"
pg_restore: creating FK CONSTRAINT "public.audit_logs audit_logs_user_id_fkey"
pg_restore: creating FK CONSTRAINT "public.refresh_tokens refresh_tokens_user_id_fkey"
[Tue Jul 29 02:05:17 PM CEST 2025] Test connessione e query base...
 table_count 
-------------
           4
(1 row)

[Tue Jul 29 02:05:26 PM CEST 2025] Test query su tabelle principali...
ERROR:  relation "fornitori" does not exist
LINE 1: ...'fornitori' as table_name, COUNT(*) as count FROM fornitori;
                                                             ^
[Tue Jul 29 02:05:32 PM CEST 2025] Pulizia database temporaneo...
[Tue Jul 29 02:05:32 PM CEST 2025] Test restore completato con successo!
